<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>고웹프(2019.1)_안전등산</title>
<!-- [템플릿 출처] Letter Template http://www.templatemo.com/tm-510-letter -->
<!-- 템플릿 부분-->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400">  <!-- Google web font "Open Sans" -->
  <link rel="stylesheet" href="css/font-awesome.min.css">
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/demo.css" />
  <link rel="stylesheet" href="css/templatemo-style.css">
  <script type="text/javascript" src="js/modernizr.custom.86080.js"></script>
<!-- js 추가-->
<script src="//developers.kakao.com/sdk/js/kakao.min.js"></script>
<script type="text/javascript" src="http://code.jquery.com/jquery-latest.js"></script>
<script src="http://dmaps.daum.net/map_js_init/postcode.v2.js"></script>
<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=f709cbbbe77b71b8c2bf7637ce5050cb&libraries=services"></script>

<!-- 한글 폰트 적용-->
  <style>
    @font-face {
      font-family: hanna;
      src:url('fonts/BMHANNAAir_ttf.ttf');
    }
    body {font-family: hanna; color:white;}
  </style>


</head>

<body>
  <!-- api script codes -->
  <script type="text/javascript">
  //KAKAO TALK
      // 사용할 앱의 JavaScript 키를 설정해 주세요.
    Kakao.init('f709cbbbe77b71b8c2bf7637ce5050cb');
/////////////////////////////
var localMap;
var markers=[];
/////////////////////////////
    //로그인 정보 확인
    function checkLoginStatus(){
      Kakao.Auth.getStatus(function(statusObj){
        if(statusObj.status == "connected"){
          //alert("로그인 성공");
          //alert(JSON.stringify(statusObj));
          //여기서 정보 파싱
          var inputString = JSON.stringify(statusObj)
          var temp1 = inputString.indexOf('id')
          var temp2 = inputString.indexOf('properties')
          kakaoID = inputString.slice(temp1+4,temp2-2)

          var temp1 = inputString.indexOf('nickname')
          var temp2 = inputString.indexOf('thumbnail_image')
          kakaoNick = inputString.slice(temp1+11,temp2-3)

          var temp1 = inputString.indexOf('thumbnail_image')
          var temp2 = inputString.indexOf('.jpg"}}}')
          kakaoImg = inputString.slice(temp1+18,temp2+4)

          //로컬 스토리지에 데이터 저장 - 먼저 있던 데이터가 현재와 같은지
          if(localStorage.getItem("kakaoID")!=kakaoID){localStorage.setItem("kakaoID",kakaoID);}
          if(localStorage.getItem("kakaoNick")!=kakaoNick){localStorage.setItem("kakaoNick",kakaoNick);}
          if(localStorage.getItem("kakaoImg")!=kakaoImg){localStorage.setItem("kakaoImg",kakaoImg);}

          //다시 틀었을때, 카카오 아이디랑 맞으면 가장 최근의 기록을 바로 띄워줌


          //지도 띄우기 - default
          var mapContainer = document.getElementById('map'), // 지도를 표시할 div
          mapOption = {
              center: new daum.maps.LatLng(33.450701, 126.570667), // 지도의 중심좌표
              level: 3 // 지도의 확대 레벨
          };
          localMap = new daum.maps.Map(mapContainer, mapOption); // 지도를 생성합니다



        }else{
          alert("로그인을 해 주세요");
          //index.html로 넘어가 로그인 하게 한다
          window.location.href = "./index.html";
        }
      });
    }
/////////////////////////
    //로그아웃
    function logout(){
      Kakao.Auth.logout(function(){
        window.location.reload()
      });
    }
/////////////////////////
    //카카오 링크 보내기 -> 내 위치 전송
    function sendCurrentLocation(){
      alert('내 위치 알리기')
      var title;
      var address;
      var friends;
      //로컬 스토리지에 내 위치값이 들어와 있는지 확인
      var Knick = localStorage.getItem("kakaoNick")
      var currnetLocation = localStorage.getItem("address")
      if(!Knick || !currnetLocation){ alert("정보가 없습니다! -> error") }
      else{
        title = '당신의 친구 '+Knick+'이 현재 아래와 같은 장소에 있습니다.'
        friends = '당신의 친구 '+Knick+'의 위치입니다.'
      }

      Kakao.Link.createDefaultButton({
        container: '#kakao-link-btn',
        objectType: 'location',
        address: currnetLocation,
        addressTitle: friends,
        content: {
          title: title,
          description: currnetLocation,
          imageUrl: './img/letter_bg_01.jpg',
          link: {
            mobileWebUrl: 'https://developers.kakao.com',
            webUrl: 'https://developers.kakao.com'
          }
        },
        buttons: [
          {
            title: '웹으로 보기',
            link: {
              mobileWebUrl: 'https://developers.kakao.com',
              webUrl: 'https://developers.kakao.com'
            }
          }
        ]
      });
    }
/////////////////////////
    //현재 위치를 로컬 스토리지에 저장하기 - 저장할 필요 없음(다시 생각)
    function setCurrentLocation(){
      alert("현재위치 얻기");
      //현재 gps값 받아오기
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(function(position){
          //coords.altitudeAccuracy 해발고도
          $.ajax({
            url: 'https://dapi.kakao.com/v2/local/geo/coord2address.json',
            type: "GET",
            headers: {'Authorization': 'KakaoAK 525d85fc1d56993f10c9481694039a7c'},
            data: {'x':position.coords.longitude,"y":position.coords.latitude},
            success: function(data){
                //alert(JSON.stringify(data));
                //로컬 스토리지에 저장 - 이미 저장된 값은 신경쓸 필요 없다
                var inputString = JSON.stringify(data);
                var temp1 = inputString.indexOf('address_name');
                var temp2 = inputString.indexOf('region_1depth_name');
                address = inputString.slice(temp1+15,temp2-3);
                localStorage.setItem("address",address);
            }, error: function(){
              alert("error rest api")
            }
          });
        });
      }else{
        alert("지도 사용 불가")
      }
    }
/////////////////////////
  //모든 참여자의 무게중심 찾기
  function searchCenter(){

  }
/////////////////////////
  //친구 갱신
  //마커 갱신(맵)
  function resetFriends(){//친구 수 받아옴
    var fl = localStorage.getItem('friendsList');
    var al = localStorage.getItem('addressInfo');
    // 지도를 재설정할 범위정보를 가지고 있을 LatLngBounds 객체를 생성합니다
    var bounds = new daum.maps.LatLngBounds();

    if(!fl || !al){
      var obj = document.getElementById("friends");
      obj.innerHTML = "";
      //지도 갱신
    }
    else{
        //리스트로 바꾸기
        var html="";
        var flList = fl.split(",");
        var aList = al.split(",");
        var centerX=0.0,centerY=0.0;

        for(var i=0;i<flList.length;i=i+2){
          var x = parseFloat(flList[i]);
          var y = parseFloat(flList[i+1]);

          //html
          html+='친구'+(i/2+1)+": "+aList[i/2]+"<br>";
          //maker 등록
          centerX+=x; centerY+=y;
          var marker = new daum.maps.Marker({
              map: localMap, // 마커를 표시할 지도
              position: new daum.maps.LatLng(x, y), // 마커를 표시할 위치
              title : '친구'+(i/2+1), // 마커의 타이틀, 마커에 마우스를 올리면 타이틀이 표시됩니다
          });
          markers.push(marker);
          bounds.extend(new daum.maps.LatLng(x, y));


        }
        var obj = document.getElementById("friends");
        obj.innerHTML = html;

        //무게중심
        searchCenter();
        //지도의 중심 계산
        localMap.setBounds(bounds);

    }


  }
  //주소입력받기 대구 북구 대학로 80
  function getAddress(e) {
    var geocoder = new daum.maps.services.Geocoder();
    new daum.Postcode({
          oncomplete: function(data) {
              var addr = data.address; // 최종 주소 변수

              // 주소 정보를 해당 필드에 넣는다.
              document.getElementById("sample5_address").value = addr;
              // 주소로 상세 정보를 검색
              geocoder.addressSearch(data.address, function(results, status) {
                  // 정상적으로 검색이 완료됐으면
                  if (status === daum.maps.services.Status.OK) {
                      var result = results[0]; //첫번째 결과의 값을 활용
                      //lert(result);
                  }
                  //데이터 저장 - size 주의! 10mb
                  var coord = [result.y,result.x]; //추가할 친구의 현 위치 y먼저!!
                  var d1=localStorage.getItem('friendsList');
                  var d2=localStorage.getItem('addressInfo');
                  if(!d1 || !d2){
                    localStorage.setItem('friendsList',coord);
                    localStorage.setItem('addressInfo',addr);
                  }
                  else{
                    localStorage.setItem('friendsList',d1+","+coord); //그냥 일렬로 저장되니 2개씩 파싱
                    localStorage.setItem('addressInfo',d2+","+addr); //이름 주소
                  }
                  //친구 추가 갱신하기- 지도, div 둘다
                  resetFriends();
              });
          }
      }).open();
  }

/////////////////////////
  //전부 삭제
  function resetAllData(){
    localStorage.removeItem('friendsList');
    localStorage.removeItem('addressInfo');
    //마커 삭제
    for (var i = 0; i < markers.length; i++) {
        markers[i].setMap(null); //됨..
    }
    resetFriends();
  }

/////////////////////////
  //main 함수같은 곳
  checkLoginStatus(); //로그인 여부 확인
  //이전 기록 찾아서 띄워주기
  </script>

			<div id="particles-js"></div>
			<ul class="cb-slideshow">
	            <li></li>
	            <li></li>
	            <li></li>
	            <li></li>
	            <li></li>
	            <li></li>
	   </ul>

			<div class="container-fluid">
				<div class="row cb-slideshow-text-container ">
          <!--  여기서 부터 코딩 -->
					<div class= "tm-content" style="width:100%; height:100%;">
            <header class="mb-5"><h1>안전*등산</h1></header>
            <div id = "personal_info" style="color:white;">
              //개인정보 출력
            </div>
            <a id="kakao-logout-btn" href="javascript:logout();">로그아웃</a>
            <div id = "input_location">
              //참여할 사람들의 위치 얻어오기
              <div id="locations">
                <form>
                  <input type="text" id="sample5_address" placeholder="주소">
                  <input type="button" onclick="getAddress()" value="주소 검색"><br>
                </form>
                <div id="friends"></div>




              </div>

              <button onclick="setCurrentLocation()">현재 위치 받아오기</button>
              <button onclick="resetAllData()">전체 삭제</button>
              <button onclick="searchCenter()">중앙 찾기</button>
              <a id="kakao-link-btn" href="javascript:sendCurrentLocation();">친구에게 위치 알리기</a>
            </div>

            <div id = "map_info">
              //지도 그리기(모든 참여자를 마커로 표시+길표시)
              <div id="map" style="width:100%;height:250px;"></div>
            </div>








					</div>
				</div>
        <!-- 저작권 및 템플릿 주소-->
				<div class="footer-link">
					<p>Copyright © 2019 2016111813 차수진
          - Design: <a rel="nofollow" href="http://www.google.com/+templatemo" target="_parent">Templatemo</a></p>
				</div>

			</div>
</body>


<script>
//여기는 html을 동적으로 관리하는 곳
/////////////////////////
  // 개인정보 출력 창
  function personal(){
    //로컬스토리지에서 정보 가져오기
    Knick = localStorage.getItem("kakaoNick")
    Kimg = localStorage.getItem("kakaoImg")
    if(!Knick || !Kimg){ alert("정보가 없습니다 -> error") }
    else{
      var obj = document.getElementById("personal_info");
      var str = "<img src='"+Kimg+"' width='40'>";
      str += "안전 등산에 오신 걸 환영합니다. "+ Knick +"님.";
      obj.innerHTML = str;
    }

  }
  personal();

/////////////////////////

</script>


<script type="text/javascript" src="js/particles.js"></script>
<script type="text/javascript" src="js/app.js"></script>
</html>
